<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ config.title }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ config.description }}{% endblock %}">

    <!-- Open Graph -->
    <meta property="og:site_name" content="{{ config.title }}">
    <meta property="og:locale" content="en_US">
    {% block og_tags %}
    <meta property="og:type" content="website">
    <meta property="og:title" content="{{ config.title }}">
    <meta property="og:description" content="{{ config.description }}">
    <meta property="og:url" content="{{ config.base_url }}">
    {% endblock og_tags %}

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@class_lambda">
    {% block twitter_tags %}
    <meta name="twitter:title" content="{{ config.title }}">
    <meta name="twitter:description" content="{{ config.description }}">
    {% endblock twitter_tags %}

    <!-- Feeds -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="{{ get_url(path="rss.xml") }}">
    <link rel="alternate" type="application/atom+xml" title="Atom" href="{{ get_url(path="atom.xml") }}">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ get_url(path="favicon.svg") }}">

    <!-- Styles -->
    <link rel="stylesheet" href="{{ get_url(path="style.css") }}">

    <!-- Preload fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]});"></script>
</head>
<body class="{% block body_class %}{% endblock %}">
    <div class="site-wrapper">
        <header class="site-header">
            <nav class="nav-container">
                <a href="{{ get_url(path="/") }}" class="site-logo">
                    <span class="logo-text">LambdaClass</span>
                </a>
                <div class="nav-links">
                    <a href="{{ get_url(path="/") }}" {% if current_path is defined and current_path == "/" %}class="active"{% endif %}>Home</a>
                    <a href="{{ get_url(path="tags") }}" {% if current_path is defined and current_path is containing("tags") %}class="active"{% endif %}>Topics</a>
                    <a href="https://github.com/lambdaclass" target="_blank" rel="noopener">GitHub</a>
                    <a href="https://x.com/class_lambda" target="_blank" rel="noopener">X</a>
                    <button class="search-toggle" id="search-toggle" aria-label="Search">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                </div>
            </nav>
        </header>

        <main class="site-main">
            {% block content %}{% endblock %}
        </main>

        <footer class="site-footer">
            <div class="footer-container">
                <div class="footer-content">
                    <p class="footer-copyright">&copy; {{ now() | date(format="%Y") }} LambdaClass. All rights reserved.</p>
                    <div class="footer-links">
                        <a href="https://github.com/lambdaclass" target="_blank" rel="noopener">GitHub</a>
                        <a href="https://x.com/class_lambda" target="_blank" rel="noopener">X</a>
                        <a href="{{ get_url(path="rss.xml") }}">RSS</a>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Back to top button -->
        <button class="back-to-top" id="back-to-top" aria-label="Back to top">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
        </button>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="search-modal">
        <div class="search-modal-overlay"></div>
        <div class="search-modal-content">
            <div class="search-header">
                <div class="search-input-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="search-input" placeholder="Search articles..." autocomplete="off">
                    <kbd>ESC</kbd>
                </div>
            </div>
            <div class="search-results" id="search-results">
                <div class="search-hint">Type to search articles...</div>
            </div>
        </div>
    </div>

    <script src="{{ get_url(path="elasticlunr.min.js") }}"></script>
    <script src="{{ get_url(path="search_index.en.js") }}"></script>
    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        // Check for saved preference or system preference
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            html.setAttribute('data-theme', savedTheme);
        } else if (systemPrefersDark) {
            html.setAttribute('data-theme', 'dark');
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Back to top button
        const backToTop = document.getElementById('back-to-top');

        window.addEventListener('scroll', () => {
            if (window.scrollY > 500) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        }, { passive: true });

        backToTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Copy code button + language label
        document.querySelectorAll('pre').forEach(pre => {
            const code = pre.querySelector('code');
            pre.style.position = 'relative';

            // Add language label
            if (code && code.className) {
                const match = code.className.match(/language-(\w+)/);
                if (match) {
                    const lang = match[1];
                    const label = document.createElement('span');
                    label.className = 'code-lang';
                    label.textContent = lang.toUpperCase();
                    pre.appendChild(label);
                }
            }

            // Add copy button
            const button = document.createElement('button');
            button.className = 'copy-code';
            button.textContent = 'COPY';
            button.setAttribute('aria-label', 'Copy code');

            button.addEventListener('click', async () => {
                const text = code ? code.textContent : pre.textContent;

                try {
                    await navigator.clipboard.writeText(text);
                    button.textContent = 'COPIED!';
                    button.classList.add('copied');
                    setTimeout(() => {
                        button.textContent = 'COPY';
                        button.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    button.textContent = 'ERROR';
                    setTimeout(() => {
                        button.textContent = 'COPY';
                    }, 2000);
                }
            });

            pre.appendChild(button);
        });

        // Heading anchor links
        document.querySelectorAll('.prose h1, .prose h2, .prose h3, .prose h4').forEach(heading => {
            if (heading.id) {
                const anchor = document.createElement('a');
                anchor.href = '#' + heading.id;
                anchor.className = 'heading-anchor';
                anchor.setAttribute('aria-label', 'Link to this section');
                anchor.textContent = '#';
                heading.appendChild(anchor);
            }
        });

        // Search functionality
        const searchToggle = document.getElementById('search-toggle');
        const searchModal = document.getElementById('search-modal');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const searchOverlay = searchModal.querySelector('.search-modal-overlay');

        function openSearch() {
            searchModal.classList.add('active');
            searchInput.focus();
            document.body.style.overflow = 'hidden';
        }

        function closeSearch() {
            searchModal.classList.remove('active');
            searchInput.value = '';
            searchResults.innerHTML = '<div class="search-hint">Type to search articles...</div>';
            document.body.style.overflow = '';
        }

        searchToggle.addEventListener('click', openSearch);
        searchOverlay.addEventListener('click', closeSearch);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchModal.classList.contains('active')) {
                closeSearch();
            }
            if ((e.key === 'k' || e.key === 'K') && (e.metaKey || e.ctrlKey)) {
                e.preventDefault();
                openSearch();
            }
        });

        let searchIdx = null;
        if (typeof elasticlunr !== 'undefined' && typeof window.searchIndex !== 'undefined') {
            searchIdx = elasticlunr.Index.load(window.searchIndex);
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            if (!query) {
                searchResults.innerHTML = '<div class="search-hint">Type to search articles...</div>';
                return;
            }

            if (!searchIdx) {
                searchResults.innerHTML = '<div class="search-hint">Search index not available</div>';
                return;
            }

            const results = searchIdx.search(query, {
                fields: { title: { boost: 2 }, body: { boost: 1 } },
                expand: true
            });

            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results">No results found for "' + query + '"</div>';
                return;
            }

            const html = results.slice(0, 10).map(result => {
                const doc = searchIdx.documentStore.getDoc(result.ref);
                const title = doc.title || 'Untitled';
                const body = doc.body || '';
                const snippet = body.substring(0, 150) + (body.length > 150 ? '...' : '');

                return `
                    <a href="${result.ref}" class="search-result-item">
                        <span class="search-result-title">${title}</span>
                        <span class="search-result-snippet">${snippet}</span>
                    </a>
                `;
            }).join('');

            searchResults.innerHTML = html;
        });
    </script>
</body>
</html>
